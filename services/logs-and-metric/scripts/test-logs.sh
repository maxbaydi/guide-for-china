#!/bin/bash

# =============================================================================
# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–±–æ—Ä–∞ –ª–æ–≥–æ–≤
# =============================================================================

set -e

echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–±–æ—Ä–∞ –ª–æ–≥–æ–≤"
echo "============================"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω—ã –ª–∏ —Å–µ—Ä–≤–∏—Å—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
if ! docker ps | grep -q "promtail\|loki\|grafana"; then
    echo "‚ùå –°–µ—Ä–≤–∏—Å—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω—ã."
    echo "   –ó–∞–ø—É—Å—Ç–∏—Ç–µ: ./scripts/setup.sh"
    exit 1
fi

echo "‚úÖ –°–µ—Ä–≤–∏—Å—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∑–∞–ø—É—â–µ–Ω—ã."

# –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –ª–æ–≥–∞–º–∏
echo "üê≥ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–µ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –µ—Å–ª–∏ –µ—Å—Ç—å
docker stop test-logging-container 2>/dev/null || true
docker rm test-logging-container 2>/dev/null || true

# –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å label –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
docker run -d \
    --name test-logging-container \
    --label logging=enabled \
    --label logging.service=test-app \
    --label logging.environment=test \
    alpine:latest \
    sh -c '
        while true; do
            echo "$(date): INFO - Test log message from test container"
            echo "$(date): ERROR - Test error message"
            echo "$(date): DEBUG - Test debug message"
            sleep 2
        done
    '

echo "‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–∑–¥–∞–Ω –∏ –∑–∞–ø—É—â–µ–Ω."

# –ñ–¥–µ–º –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –ª–æ–≥–æ–≤
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –ª–æ–≥–æ–≤ (10 —Å–µ–∫—É–Ω–¥)..."
sleep 10

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –≤ Loki
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –≤ Loki..."
LOKI_URL="http://localhost:3100"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Loki
if curl -s "$LOKI_URL/ready" > /dev/null; then
    echo "‚úÖ Loki –¥–æ—Å—Ç—É–ø–µ–Ω."
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ª–µ–π–±–ª–æ–≤
    echo "üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –ª–µ–π–±–ª—ã –≤ Loki:"
    curl -s "$LOKI_URL/loki/api/v1/labels" | jq -r '.data[]' 2>/dev/null || echo "   (jq –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏)"
    
    # –ü–æ–ª—É—á–∞–µ–º –ª–æ–≥–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    echo ""
    echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:"
    curl -s "$LOKI_URL/loki/api/v1/query_range" \
        -G \
        -d 'query={container_name="test-logging-container"}' \
        -d 'start='$(date -d '5 minutes ago' -u +%Y-%m-%dT%H:%M:%SZ) \
        -d 'end='$(date -u +%Y-%m-%dT%H:%M:%SZ) \
        -d 'limit=10' | jq -r '.data.result[].values[][1]' 2>/dev/null || echo "   (jq –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Grafana –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤)"
else
    echo "‚ùå Loki –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É $LOKI_URL"
fi

echo ""
echo "üåê –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ Grafana:"
echo "   1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3000"
echo "   2. –í–æ–π–¥–∏—Ç–µ –∫–∞–∫ admin/admin"
echo "   3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª 'Explore'"
echo "   4. –í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö 'Loki'"
echo "   5. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∑–∞–ø—Ä–æ—Å: {container_name=\"test-logging-container\"}"

echo ""
echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
docker stop test-logging-container
docker rm test-logging-container
echo "‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–¥–∞–ª–µ–Ω."

echo ""
echo "üéâ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "   –ï—Å–ª–∏ –ª–æ–≥–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ Grafana, —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ."
